<!DOCTYPE html>
<html>
<head>
    <title>WPI Sailbot Telemetry</title>
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/simple-grid.min.css" rel="stylesheet">
    <link href="css/foundation.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link href="/assets/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/assets/favicon.ico" rel="icon" type="image/x-icon">

    <!-- Include eel.js - note this file doesn't exist in the 'web' directory -->
    <script src="/eel.js" type="text/javascript"></script>
    <link href="/css/leaflet.css" rel="stylesheet"/>
    <script src="/dependencies/leaflet.js"></script>
    <script src="/dependencies/canvas-gauges.js" type="text/javascript"></script>
    <script src="/dependencies/leaflet-triangle-marker.js" type="text/javascript"></script>
    <script src="/dependencies/leaflet-rotate-marker.js" type="text/javascript"></script>

    <script type="text/javascript">
        function print_number_js(x) {
            console.log(x);
        }

        eel.expose(print_number_js);               // Expose this function to Python
        function say_hello_js(x) {
            console.log("Hello from " + x);
        }

        eel.expose(say_hello_js);               // Expose this function to Python

        say_hello_js("Javascript World!");
        eel.say_hello_py("Javascript World!");  // Call a Python function

        var activeLines = [];
        function DrawLines(lines) {
            for(let i=0; i<activeLines.length; i++) {
                map.removeLayer(activeLines[i]);
            }
            for(let i=0; i<lines.length; i++) {
                const lat1 = lines[i][0];
                const long1 = lines[i][1];
                const lat2 = lines[i][2];
                const long2 = lines[i][3];

                // Define the coordinates of your points
                const pointA = L.latLng(lat1, long1);
                const pointB = L.latLng(lat2, long2);
                // Create an array of coordinates for the path
                const pathCoordinates = [pointA, pointB];

                // Create a Polyline using the path coordinates
                const polyline = L.polyline(pathCoordinates, {color: 'red', weight: 5}).addTo(map);
                const polyline1 = L.polyline(pathCoordinates, {color: 'blue', weight: 2}).addTo(map);

                activeLines.push(polyline);
                activeLines.push(polyline1);
                // Fit the map to the bounds of the polyline
                //map.fitBounds(polyline.getBounds());
            }
        }

        eel.expose(DrawLines);

    </script>
    <!-- load leaflet.js -->
</head>

<body>
<div id="map" style="width: 100%; height: 100vh;"></div>
<!-- prettier-ignore -->
<script>
    var map = L.map('map').setView([51.505, -0.09], 13); // Set the initial coordinates and zoom level
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    //heading marker
    

    //boat icon
    var arrowIcon = L.icon({
        iconUrl: 'assets/arrow.png', // Path to your custom icon image
        iconSize: [32, 32],  // Size of the icon
        iconAnchor: [16, 32] // Anchor point of the icon (usually the bottom center)
    });
    var boatIcon = L.icon({
        iconUrl: 'assets/boat.png', // Path to your custom icon image
        iconSize: [32, 32],  // Size of the icon
        iconAnchor: [16, 16] // Anchor point of the icon (usually the bottom center)
    });
    var arrowMarker = L.marker([51.505, -0.09], { icon: arrowIcon, rotationAngle: 90, rotationOrigin: "bottom center" }).addTo(map);
    var boatMarker = L.marker([51.505, -0.09], { icon: boatIcon, rotationOrigin: "center" }).addTo(map);
    function updateBoatPosition(newLat, newLong){
        var newLatLng = L.latLng(newLat, newLong)
        boatMarker.setLatLng(newLatLng)
        arrowMarker.setLatLng(newLatLng)
    }
    eel.expose(updateBoatPosition)
</script>
<!--<div id="textbox">
  <p>This is a text box overlay.</p>
</div>-->
<div id="node-status-container" style="position: absolute; top: 70%; right: 0; transform: translateY(-50%); z-index: 1000;">
    <div class="node_status" id="NetworkComms">
        <p>network_comms</p>
    </div>
    <div class="node_status" id="AirmarReader">
        <p>airmar_reader</p>
    </div>
    <div class="node_status" id="BatteryMonitor">
        <p>battery_monitor</p>
    </div>
    <div class="node_status" id="ControlSystem">
        <p>control_system</p>
    </div>
    <div class="node_status" id="PWMController">
        <p>pwm_controller</p>
    </div>
    <div class="node_status" id="TrimTabComms">
        <p>trim_tab_comms</p>
    </div>
    <script>
        var statusDivs = document.getElementsByClassName("node_status")
        function NetworkCommsUp(){
            document.getElementById("NetworkComms").style.backgroundColor = "green";
        }
        eel.expose(NetworkCommsUp);
        function NetworkCommsDown(){
            document.getElementById("NetworkComms").style.backgroundColor = "red";
        }
        eel.expose(NetworkCommsDown);
        function AirmarReaderUp(){
            document.getElementById("AirmarReader").style.backgroundColor = "green";
        }
        eel.expose(AirmarReaderUp);
        function AirmarReaderDown(){
            document.getElementById("AirmarReader").style.backgroundColor = "red";
        }
        eel.expose(AirmarReaderDown)
        function BatteryMonitorUp(){
            document.getElementById("BatteryMonitor").style.backgroundColor = "green";
        }
        eel.expose(BatteryMonitorUp)
        function BatteryMonitorDown(){
            document.getElementById("BatteryMonitor").style.backgroundColor = "red";
        }
        eel.expose(BatteryMonitorDown);
        function ControlSystemUp(){
            document.getElementById("ControlSystem").style.backgroundColor = "green";
        }
        eel.expose(ControlSystemUp);
        function ControlSystemDown(){
            document.getElementById("ControlSystem").style.backgroundColor = "red";
        }
        eel.expose(ControlSystemDown);
        function PWMControllerUp(){
            document.getElementById("PWMController").style.backgroundColor = "green";
        }
        eel.expose(PWMControllerUp);
        function PWMControllerDown(){
            document.getElementById("PWMController").style.backgroundColor = "red";
        }
        eel.expose(PWMControllerDown);
        function TrimTabCommsUp(){
            document.getElementById("TrimTabComms").style.backgroundColor = "green";
        }
        eel.expose(TrimTabCommsUp);
        function TrimTabCommsDown(){
            document.getElementById("TrimTabComms").style.backgroundColor = "red";
        }
        eel.expose(TrimTabCommsDown);
        for (const div of statusDivs){
            window[div.id+"_restart"] = () => {
                console.log("Called function of "+div.id);
            }
        }
        
    </script>
</div>
<div id="panel-1"
     style="position: absolute; top: 0px; left: 50%; transform: translateX(-50%); z-index: 1000; background-color: lightgrey; padding: 0px; border-radius: 20px; display: flex; align-items: center; overflow: auto; flex-direction: row">
    <div id="gauge-container" style="margin-right: 20px; margin-left: 20px">
        <canvas id="compass"
                width="180"
                height="180"
                data-animation-duration="1500"
                data-animation-rule="linear"
                data-border-inner-width="0"
                data-border-middle-width="0"
                data-border-outer-width="10"
                data-border-shadow-width="0"
                data-borders="true"
                data-color-border-outer="#ccc"
                data-color-border-outer-end="#ccc"
                data-color-circle-inner="#fff"
                data-color-major-ticks="#222"
                data-color-minor-ticks="#555"
                data-color-needle="rgba(240, 128, 128, 1)"
                data-color-needle-circle-outer="#ccc"
                data-color-needle-end="rgba(255, 160, 122, .9)"
                data-color-needle-shadow-down="#222"
                data-color-numbers="#555"
                data-highlights="false"
                data-major-ticks="N,NE,E,SE,S,SW,W,NW,N"
                data-max-value="360"
                data-min-value="0"
                data-minor-ticks="22"
                data-needle-circle-outer="false"
                data-needle-circle-size="15"
                data-needle-end="99"
                data-needle-start="50"
                data-needle-type="line"
                data-needle-width="3"
                data-start-angle="180"
                data-stroke-ticks="false"
                data-ticks-angle="360"
                data-type="radial-gauge"
                data-value-box="false"
                data-value-text-shadow="false"
        ></canvas>
        <div style="text-align: center; margin-top: -15px; user-select: none;">
            <p>Heading</p>
        </div>
    </div>
    <div id="gauge-container-1" style="margin-left: 20px; margin-right: 20px">
        <canvas id="boat-speed"
                width="170"
                height="170"
                data-animation-duration="1500"
                data-animation-rule="linear"
                data-border-inner-width="0"
                data-border-middle-width="0"
                data-border-outer-width="10"
                data-border-shadow-width="0"
                data-borders="true"
                data-color-border-outer="#ccc"
                data-color-border-outer-end="#ccc"
                data-color-needle-shadow-down="#222"
                data-color-plate="#fff"
                data-highlights="[]"
                data-major-ticks="0,5,10,15,20"
                data-max-value="20"
                data-needle-circle-inner="false"
                data-needle-circle-outer="true"
                data-needle-circle-size="7"
                data-needle-type="arrow"
                data-needle-width="2"
                data-type="radial-gauge"
                data-units="Km/h"
        ></canvas>
        <div style="text-align: center; margin-top: -15px; user-select: none;">
            <p>Speed</p>
        </div>
    </div>
</div>
<div id="panel-2"
     style="position: absolute; top: 50%; left: 0px; transform: translateY(-50%); z-index: 1000; background-color: lightgrey; width: 200px; padding: 10px; border-radius: 20px">
    <div id="gauge-container-2">
        <div style="text-align: center; margin-bottom: -15px; user-select: none;">
            <p>Apparent wind</p>
        </div>
        <canvas id="wind-apparent"
                width="150"
                height="150"
                data-animation-duration="1500"
                data-animation-rule="linear"
                data-border-inner-width="0"
                data-border-middle-width="0"
                data-border-outer-width="10"
                data-border-shadow-width="0"
                data-borders="true"
                data-color-border-outer="#ccc"
                data-color-border-outer-end="#ccc"
                data-color-circle-inner="#fff"
                data-color-major-ticks="#222"
                data-color-minor-ticks="#555"
                data-color-needle="rgba(240, 128, 128, 1)"
                data-color-needle-circle-outer="#ccc"
                data-color-needle-end="rgba(255, 160, 122, .9)"
                data-color-needle-shadow-down="#222"
                data-color-numbers="#555"
                data-highlights="false"
                data-major-ticks="0,45,90,135,180,225,270,315,0"
                data-max-value="360"
                data-min-value="0"
                data-minor-ticks="22"
                data-needle-circle-outer="false"
                data-needle-circle-size="15"
                data-needle-end="99"
                data-needle-start="50"
                data-needle-type="line"
                data-needle-width="3"
                data-start-angle="180"
                data-stroke-ticks="false"
                data-ticks-angle="360"
                data-type="radial-gauge"
                data-value-box="false"
                data-value-text-shadow="false"
        ></canvas>
    </div>
    <div id="gauge-container-3">
        <div style="text-align: center; margin-bottom: -15px; user-select: none;">
            <p>True wind</p>
        </div>
        <canvas id="wind-true"
                width="150"
                height="150"
                data-animation-duration="1500"
                data-animation-rule="linear"
                data-border-inner-width="0"
                data-border-middle-width="0"
                data-border-outer-width="10"
                data-border-shadow-width="0"
                data-borders="true"
                data-color-border-outer="#ccc"
                data-color-border-outer-end="#ccc"
                data-color-circle-inner="#fff"
                data-color-major-ticks="#222"
                data-color-minor-ticks="#555"
                data-color-needle="rgba(240, 128, 128, 1)"
                data-color-needle-circle-outer="#ccc"
                data-color-needle-end="rgba(255, 160, 122, .9)"
                data-color-needle-shadow-down="#222"
                data-color-numbers="#555"
                data-highlights="false"
                data-major-ticks="N,NE,E,SE,S,SW,W,NW,N"
                data-max-value="360"
                data-min-value="0"
                data-minor-ticks="22"
                data-needle-circle-outer="false"
                data-needle-circle-size="15"
                data-needle-end="99"
                data-needle-start="50"
                data-needle-type="line"
                data-needle-width="3"
                data-start-angle="180"
                data-stroke-ticks="false"
                data-ticks-angle="360"
                data-type="radial-gauge"
                data-value-box="false"
                data-value-text-shadow="false"
        ></canvas>
    </div>
</div>
<div id="contextMenu" style="display: none; z-index: 1000;">
    <ul>
        <li>Restart</li>
    </ul>
</div>
<script>
    const contextMenu = document.getElementById('contextMenu');
    let selectedDivID = ""
    function onSelect(e, selectedDiv){
        e.preventDefault(); // Prevent the default context menu
        
         // Get the position of the div and the size of the context menu
        const divRect = selectedDiv.getBoundingClientRect();
        const menuRect = contextMenu.getBoundingClientRect();

        // Calculate the position for the context menu
        let left = e.pageX;
        let top = e.pageY;

        // Check if the menu would go off the right edge of the screen
        width = Math.max(menuRect.width, 100)
        if (left +  width> window.innerWidth) {
            left = window.innerWidth - width;
        }

        // Check if the menu would go off the bottom edge of the screen
        if (top + menuRect.height > window.innerHeight) {
            top = window.innerHeight - menuRect.height;
        }

        contextMenu.style.display = 'block';
        contextMenu.style.left = `${left}px`;
        contextMenu.style.top = `${top}px`;
        
        selectedDiv.style.borderColor = '#3498db'; // Add your preferred blue shading color
        selectedDivID = selectedDiv.id;
        //remove shading from unselected divs
        for (const div of statusDivs){
            if (!(div.id === selectedDiv.id)){
                div.style.borderColor = 'transparent';
            }
        }
    }

    //strange function calls necessary to make border change work when text is clicked instead of background
    for (const div of statusDivs){
        div.addEventListener('contextmenu', (e) => {
            onSelect(e, div)
        });
    }

    const menuItems = contextMenu.querySelectorAll('li');

    menuItems.forEach((item) => {
        item.addEventListener('click', () => {
            alert(`Restarting `+selectedDivID);
            //cursed
            window[selectedDivID+"_restart"]();
            contextMenu.style.display = 'none'; // Hide the context menu
        });
    });

    // Hide the context menu when clicking outside of it
    document.addEventListener('click', () => {
        contextMenu.style.display = 'none';
        // Remove the shading effect from the divs
        for (const div of statusDivs){
            div.style.borderColor = 'transparent';
        }
    });
</script>
<script>
    // var gauges = document.getElementsByTagName('canvas');
    // var compass = gauges[0];
    // var speed = gauges[1];

    var compass = document.getElementById("compass")
    var boat_speed = document.getElementById("boat-speed")
    var wind_apparent = document.getElementById("wind-apparent")
    var wind_true = document.getElementById("wind-true")

    function updateHeading(x) {
        console.log(x)
        compass.setAttribute("data-value", x);
        //boatMarker.setRotationAngle(x)
        arrowMarker.setRotationAngle(x)
    }
    eel.expose(updateHeading);

    function updateBoatSpeed(x) {
        boat_speed.setAttribute("data-value", x);
    }
    eel.expose(updateBoatSpeed);

    function updateApparentWind(x){
        wind_apparent.setAttribute("data-value", x)
    }
    eel.expose(updateApparentWind)

    function updateTrueWind(x){
        wind_true.setAttribute("data-value", x)
    }
    eel.expose(updateTrueWind)




</script>
<div id="wing_container" style="width: 100px; height: 400px; position: absolute; top: 0px; left: 100%; transform: translateX(-100%); z-index: 1000; background-color: lightgray; border-radius: 20px;">
    <object id="wingImage" data="assets/wing.svg" type="image/svg+xml" style="transform: scaleY(-1); display: block; margin-left: auto; margin-right: auto; margin-bottom: 0;"></object>
    <canvas id="trimTabCanvas" width="100" height="100" style="margin-top: 0;"></canvas>
    <script>
        // Get a reference to the canvas element
        let canvas = document.getElementById('trimTabCanvas');
        let image = document.getElementById('wing_container')
        canvas.width = image.getBoundingClientRect().width;
        console.log("width: "+String(canvas.width))
      
        // Get a 2D drawing context
        let ctx = canvas.getContext('2d');
      
        // Set line properties (optional)
        ctx.strokeStyle = 'blue';  // Line color
        ctx.lineWidth = 2;         // Line width
      
        // Draw the line
        ctx.beginPath();
        let box = canvas.getBoundingClientRect();
        let len = 40
        let theta = Math.PI/4
        ctx.moveTo(box.width/2, 0);
        let currentTargetX = box.width/2+len*Math.cos(theta);
        let currentTargetY = len*Math.sin(theta)
        ctx.lineTo(currentTargetX, currentTargetY);
        ctx.stroke();

        var isDragging = false;
        var offsetX, offsetY;

        function drawCircle(x, y, radius) {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, 2 * Math.PI);
            ctx.fillStyle = 'red';
            ctx.fill();
            ctx.closePath();
        }

        // Draw an initial circle
        var circleRadius = 5;
        drawCircle(currentTargetX, currentTargetY, circleRadius);

        function checkCollision(x, y) {
            var dx = x - currentTargetX;
            var dy = y - currentTargetY;
            return Math.sqrt(dx * dx + dy * dy) < circleRadius;
        }

        canvas.addEventListener('mousedown', function (e) {
            var mouseX = e.clientX - canvas.getBoundingClientRect().left;
            var mouseY = e.clientY - canvas.getBoundingClientRect().top;

            if (checkCollision(mouseX, mouseY)) {
                isDragging = true;
                offsetX = mouseX - currentTargetX;
                offsetY = mouseY - currentTargetY;
            }
        });

        canvas.addEventListener('mousemove', function (e) {
            if (isDragging) {
                var mouseX = e.clientX - canvas.getBoundingClientRect().left;
                var mouseY = e.clientY - canvas.getBoundingClientRect().top;
                currentTargetX = mouseX - offsetX;
                currentTargetY = mouseY - offsetY;
                console.log("currentx/len: "+String(currentTargetX/len))
                let secondQuadrant = false
                if(currentTargetX>len){
                    currentTargetX-=canvas.getBoundingClientRect().width/2
                    secondQuadrant=true
                }
                currentTheta = Math.PI-Math.asin(currentTargetX/len)
                if(secondQuadrant){
                    currentTheta-=Math.PI/2
                }
                currentTargetX = box.width/2+len*Math.cos(currentTheta)
                currentTargetY = len*Math.sin(currentTheta)
                console.log("current x: "+String(currentTargetX+" Current y: "+String(currentTargetY)))
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
                drawCircle(currentTargetX, currentTargetY, circleRadius);
            }
        });

        window.addEventListener('mouseup', function () {
            isDragging = false;
        });
      </script>      
</div>
</body>
</html>